<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <style>
            html * {
                font-size: 125%;
            }
            .card {
                width: 120px;
                height: 180px;
                display: inline-block;
                padding: 0.12em;
                background-image: url("assets/spritesheet.png")
            }
            body {
                font-family: 'sans-serif';
            }
        </style>
        <link rel="stylesheet" href="/assets/cardsprites.css"/>
    </head>
    <body>
        <h1>Blackjack</h1>
        <button id="dealButton">Deal</button>
        <h2>Player's Hand</h2>
        <div id="playerDeck"></div>
        <h2>House's Hand</h2>
        <div id="opponentDeck"></div>
        <script lang="javascript">
            "use strict";
            function $(id) {
                return document.getElementById(id);
            }
            var playerDeckView = undefined;
            var opponentDeckView = undefined;
            var gameState = undefined;
            class AssetManager {
                static getCardStyleClassName(card) {
                    //name,suit,color
                    return `_${card.assetName()}`;
                }
            }
            class CardDeckView {
                rootElem=undefined;
                playerCards=undefined;
                constructor(selector,cards) {
                    this.rootElem = $(selector);
                    this.playerCards = cards;
                }
                clearCards() {
                    this.playerCards = [];
                    while (this.rootElem.firstChild) {
                        this.rootElem.removeChild(this.rootElem.firstChild);
                    }
                }
                addCard(card) {
                    this.playerCards.push(card);
                    var cardElem = document.createElement("div");
                    cardElem.className = "card " + AssetManager.getCardStyleClassName(card);
                    this.rootElem.appendChild(cardElem);
                }
            }
            class Card {
                static CARD_NAME_CODES = {"Ace":"a", "King":"k", "Queen":"q", "Jack":"j",
                    "Ten":"10", "Nine":"9", "Eight":"8", "Seven":"7", "Six":"6", "Five":"5", 
                    "Four":"4", "Three":"3", "Two":"2" };
                static CARD_NAME_SCORES = {"Ace":1, "King":10, "Queen":10, "Jack":10,
                    "Ten":10, "Nine":9, "Eight":8, "Seven":7, "Six":6, "Five":5, 
                    "Four":4, "Three":3, "Two":2 };
                static SUIT_NAME_CODES = {"Diamonds":"d","Hearts":"h","Clubs":"c","Spades":"s"};
                static COLOR_NAME_CODES = {"Red":"r","Black":"b"};
                static ALLOWED_SUIT_COLORS = [0,0,1,1];
                static NUM_CARD_NAMES = Object.keys(Card.CARD_NAME_CODES).length;
                static NUM_CARD_SUITS = Object.keys(Card.SUIT_NAME_CODES).length;
                static NUM_CARD_COLORS = Object.keys(Card.COLOR_NAME_CODES).length;
                //Bit layout for card value:
                //4,3,1
                //nnnnsssc
                cardValue;
                cardName() {
                    var nameId = this.cardValue >> 4;
                    return Card.CARD_NAME_CODES[Object.keys(Card.CARD_NAME_CODES)[nameId]];
                }
                suitName() {
                    var suitId = (this.cardValue & 0xf) >> 1;
                    return Card.SUIT_NAME_CODES[Object.keys(Card.SUIT_NAME_CODES)[suitId]];
                }
                colorName() {
                    var suitId = (this.cardValue & 0xf) >> 1;
                    return ( Card.COLOR_NAME_CODES[ 
                        Object.keys(Card.COLOR_NAME_CODES)[Card.ALLOWED_SUIT_COLORS[suitId]]
                    ]);
                }
                assetName() {
                    return `${this.cardName()}${this.suitName()}${this.colorName()}`;
                }
                constructor(cardValue) {
                    this.cardValue = cardValue;
                }
            }
            class GameState
            {
                playerCards=[];
                oppCards=[];
                static exclLowerId = Object.keys(Card.CARD_NAME_CODES).indexOf("King");
                static exclUpperId = Object.keys(Card.CARD_NAME_CODES).indexOf("Jack");
                checkWinner() {
                    var playerScore = 0;
                    var oppScore = 0;
                    this.playerCards.forEach(e => {
                        var nameId = currentId >> 4;
                        playerScore += Card.CARD_NAME_SCORES[nameId];
                    });
                    this.oppCards.forEach(e => {
                        var nameId = currentId >> 4;
                        oppScore += Card.CARD_NAME_SCORES[nameId];
                    });
                    if (playerScore > oppScore && playerScore <= 21) {
                        alert("Player Wins");
                    } else if (oppScore < playerScore && oppScore <= 21) {
                        alert("House Wins");
                    }
                }
            }
            function crng() {
                var tempArray = new Uint32Array(52);
                self.crypto.getRandomValues(tempArray);
                return tempArray[Math.floor(Math.random() * tempArray.length)] / 0xffffffff;
            }
            function randomCardId() {
                var currentId = undefined;
                Math.random();
                var nameId = Math.floor( crng() * Card.NUM_CARD_NAMES  );
                /*
                In Blackjack, face value cards are allowed.
                do {
                    nameId = Math.floor( crng() * Card.NUM_CARD_NAMES  );
                } while (nameId >= GameState.exclLowerId
                    && nameId <= GameState.exclUpperId)
                    */
                currentId = 
                    nameId << 4 |
                    Math.floor( crng() * Card.NUM_CARD_SUITS  ) << 1;
                currentId = currentId | Card.ALLOWED_SUIT_COLORS[(currentId & 0xf) >> 1];
                return currentId;
            }
            function dealCards(deckView) {
                deckView.clearCards();
                var cardIds = [];
                var currentId = 0;
                let DEAL_NUM_CARDS = 7;
                for (var i=0; i < DEAL_NUM_CARDS; ++i) {
                    do {
                        currentId = randomCardId();
                    } while (cardIds.indexOf(currentId) != -1)
                    cardIds.push(currentId);
                    var card = new Card(currentId);
                    deckView.addCard(card);
                }
            }
            document.onreadystatechange = () => {
                gameState = new GameState();
                playerDeckView = new CardDeckView("playerDeck",gameState.playerCards);
                opponentDeckView = new CardDeckView("opponentDeck",gameState.oppCards);
                $("dealButton").addEventListener("click", (e)=>{
                    dealCards(playerDeckView);
                    dealCards(opponentDeckView);
                    gameState.checkWinner();
                });
            }
        </script>
    </body>
</html>